<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Wasabi - Share Photos</title>

    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&display=swap" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">Wasabi</div>
            <div class="act">
                <a href="/origami/view" class="upload-btn"
                    style="background:transparent; color:#262626; border:1px solid #dbdbdb;">Gallery</a>
            </div>
        </div>
    </nav>

    <div class="container" style="max-width: 600px;">
        <div
            style="background: white; border: 1px solid #dbdbdb; border-radius: 3px; padding: 40px; text-align: center;">
            <h2 style="font-weight: 300; margin-bottom: 20px; font-size: 24px; color:#262626;">Upload New Photo</h2>

            <form enctype='multipart/form-data' method="POST" action="/origami/form" x-data="{ 
                files1: null, 
                files2: null, 
                preview: null,
                allFilters: [],
                filterMode: 'list', 
                selectedFilter: '',
                hoveredFilter: null,
                debounceTimer: null,
                
                init() {
                    fetch('/origami/filters')
                        .then(r => r.json())
                        .then(data => {
                            this.allFilters = data.sort();
                        })
                        .catch(e => console.error('Error fetching filters:', e));
                },

                updatePreview(debounceMs = 0) {
                     if (this.debounceTimer) clearTimeout(this.debounceTimer);
                     this.debounceTimer = setTimeout(() => this._doUpdatePreview(), debounceMs);
                },

                async _doUpdatePreview() {
                     if (!this.files1 || this.files1.length === 0) {
                         this.preview = null;
                         return;
                     }

                     let formData = new FormData();
                     formData.append('customFile', this.files1[0]);
                     
                     let hasFilter = false;
                     // Logic: If hovering (not null), use hover. Else use selected.
                     let activeFilter = (this.hoveredFilter !== null) ? this.hoveredFilter : this.selectedFilter;
                     
                     if(this.filterMode === 'file' && this.files2 && this.files2.length > 0) {
                         formData.append('filter', this.files2[0]);
                         hasFilter = true;
                     } else if(this.filterMode === 'list' && activeFilter) {
                         formData.append('filterClass', activeFilter);
                         hasFilter = true;
                     }

                     if (hasFilter) {
                         try {
                             let res = await fetch('/origami/preview', {
                                 method: 'POST',
                                 body: formData
                             });
                             if (res.ok) {
                                 let blob = await res.blob();
                                 this.preview = URL.createObjectURL(blob);
                             }
                         } catch(e) { console.error(e); }
                     } else {
                         let reader = new FileReader();
                         reader.onload = (e) => { this.preview = e.target.result; };
                         reader.readAsDataURL(this.files1[0]);
                     }
                }
            }" x-init="init()">

                <div style="border: 2px dashed #dbdbdb; min-height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer; position:relative; overflow: hidden; background-color: #f8f9fa;"
                    class="hover:border-gray-400 transition"
                    :style="(hoveredFilter !== null) ? 'border-color: #0095f6;' : ''">
                    <input name="customFile" type="file" id="customFile"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        x-on:change="files1 = Object.values($event.target.files); updatePreview()"
                        style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index: 10;"
                        required>

                    <div x-show="!preview" style="text-align: center; padding: 40px;">
                        <i class="fas fa-image fa-3x" style="color:#dbdbdb; margin-bottom:10px;"></i>
                        <p style="color:#8e8e8e;">Drag photos here or click to select</p>
                    </div>

                    <div x-show="preview" style="width:100%; display: flex; justify-content: center;">
                        <img :src="preview"
                            style="max-width: 100%; max-height: 400px; width: auto; height: auto; object-fit: contain;">
                    </div>

                    <div x-show="hoveredFilter !== null"
                        style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:4px 8px; border-radius:4px; font-size:12px; pointer-events:none; z-index: 20;">
                        Preview: <span x-text="hoveredFilter ? hoveredFilter.split('.').pop() : 'Normal'"></span>
                    </div>
                </div>

                <div class="mb-4" style="text-align: left;">

                    <div
                        style="display:flex; justify-content: space-between; align-items:center; margin-bottom:10px; font-size:14px;">
                        <label style="font-weight:600; color:#262626;">Filter Effect</label>
                        <div>
                            <label style="margin-right:10px; cursor:pointer;">
                                <input type="radio" x-model="filterMode" value="list" @change="updatePreview()"> List
                            </label>
                            <label style="cursor:pointer;">
                                <input type="radio" x-model="filterMode" value="file" @change="updatePreview()"> Upload
                            </label>
                        </div>
                    </div>

                    <div x-show="filterMode === 'list'">
                        <div class="filter-bar" @mouseleave="hoveredFilter = null; updatePreview(300)">
                            <!-- Normal Option -->
                            <div class="filter-chip" :class="{'active': !selectedFilter}"
                                @click="selectedFilter = ''; updatePreview()"
                                @mouseenter="hoveredFilter = ''; updatePreview(200)">
                                Normal
                            </div>

                            <!-- Dynamic Filters -->
                            <template x-for="f in allFilters" :key="f">
                                <div class="filter-chip" :class="{'active': selectedFilter === f}"
                                    @click="selectedFilter = f; updatePreview()"
                                    @mouseenter="hoveredFilter = f; updatePreview(200)">
                                    <span x-text="f.split('.').pop()"></span>
                                </div>
                            </template>
                        </div>
                        <input type="hidden" name="filterClass" :value="selectedFilter">
                    </div>

                    <div x-show="filterMode === 'file'">
                        <input name="filter" type="file"
                            x-on:change="files2 = Object.values($event.target.files); updatePreview()"
                            style="width:100%; padding:8px; border:1px solid #dbdbdb; background:#fafafa; border-radius:3px;">
                    </div>
                </div>

                <div class="mb-4" style="text-align: left; margin-bottom:20px;">
                    <label
                        style="display:block; font-weight:600; font-size:14px; margin-bottom:5px; color:#262626;">Tags</label>
                    <input type="text" name="tags" placeholder="e.g. summer, beach (comma separated)"
                        style="width: 100%; padding: 10px; border: 1px solid #dbdbdb; background: #fafafa; border-radius: 3px; outline:none;">
                </div>

                <button type="submit" class="upload-btn"
                    style="width: 100%; padding: 10px; font-size: 14px;">Share</button>
            </form>
        </div>
    </div>
</body>

</html>